const express = require('express');
const http = require('http');
const path = require('path');
const socketIo = require('socket.io');

const app = express();
const server = http.createServer(app);
const io = socketIo(server);

const PORT = process.env.PORT || 3000;

// Sirve archivos est√°ticos de /public
app.use(express.static(path.join(__dirname, 'public')));

// Panel de control SOLO en "/"
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'control.html'));
});

// QR en "/qr"
app.get('/qr', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'qr.html'));
});

// P√°gina de hackeo en "/hack"
app.get('/hack', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// P√°gina para detener efectos
app.get('/stop', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'stop.html'));
});

// P√°gina de prueba de vibraci√≥n espec√≠fica
app.get('/vibrate-test', (req, res) => {
    res.send(`
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Vibraci√≥n</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            padding: 20px; 
            background: #000; 
            color: white; 
        }
        button { 
            padding: 30px; 
            margin: 20px; 
            font-size: 24px; 
            border: none; 
            border-radius: 15px; 
            cursor: pointer; 
            color: white; 
            width: 90%; 
            max-width: 400px; 
        }
        .test1 { background: #ff0000; }
        .test2 { background: #00ff00; }
        .test3 { background: #0000ff; }
        .test4 { background: #ff00ff; }
        .info { 
            background: #333; 
            padding: 20px; 
            margin: 20px auto; 
            border-radius: 10px; 
            max-width: 500px; 
        }
    </style>
</head>
<body>
    <h1>üîß PRUEBA DE VIBRACI√ìN</h1>
    
    <div class="info" id="deviceInfo">
        <h3>Informaci√≥n del Dispositivo:</h3>
        <p id="userAgent"></p>
        <p id="vibrateSupport"></p>
        <p id="instructions"></p>
    </div>
    
    <button class="test1" ontouchstart="vibrateTest1()" onclick="vibrateTest1()">
        üì≥ PRUEBA 1: Vibraci√≥n Simple
    </button>
    
    <button class="test2" ontouchstart="vibrateTest2()" onclick="vibrateTest2()">
        üö® PRUEBA 2: Vibraci√≥n Fuerte
    </button>
    
    <button class="test3" ontouchstart="vibrateTest3()" onclick="vibrateTest3()">
        ‚ö° PRUEBA 3: Vibraci√≥n Continua (10s)
    </button>
    
    <button class="test4" ontouchstart="stopVibration()" onclick="stopVibration()">
        ‚èπÔ∏è DETENER VIBRACI√ìN
    </button>
    
    <div class="info">
        <h3>üìã Checklist:</h3>
        <p>‚úÖ ¬øEst√°s en un tel√©fono m√≥vil REAL?</p>
        <p>‚úÖ ¬øEst√° activada la vibraci√≥n en configuraci√≥n?</p>
        <p>‚úÖ ¬øNo est√° en modo silencioso?</p>
        <p>‚úÖ ¬øTocaste la pantalla primero?</p>
    </div>
    
    <script>
        let vibrateInterval = null;
        
        // Mostrar informaci√≥n del dispositivo
        document.getElementById('userAgent').textContent = 'Navegador: ' + navigator.userAgent;
        document.getElementById('vibrateSupport').textContent = 'Vibraci√≥n: ' + (navigator.vibrate ? '‚úÖ SOPORTADA' : '‚ùå NO SOPORTADA');
        document.getElementById('instructions').innerHTML = navigator.vibrate ? 
            'üü¢ Tu dispositivo soporta vibraci√≥n. Prueba los botones.' : 
            'üî¥ Tu dispositivo NO soporta vibraci√≥n.';
        
        function vibrateTest1() {
            console.log('Intentando vibraci√≥n simple...');
            if (navigator.vibrate) {
                navigator.vibrate(1000); // 1 segundo
                alert('Vibraci√≥n simple activada (1 segundo)');
            } else {
                alert('‚ùå Vibraci√≥n no soportada en este dispositivo');
            }
        }
        
        function vibrateTest2() {
            console.log('Intentando vibraci√≥n fuerte...');
            if (navigator.vibrate) {
                navigator.vibrate([500, 100, 500, 100, 500]); // Patr√≥n fuerte
                alert('Vibraci√≥n fuerte activada');
            } else {
                alert('‚ùå Vibraci√≥n no soportada en este dispositivo');
            }
        }
        
        function vibrateTest3() {
            console.log('Iniciando vibraci√≥n continua...');
            stopVibration(); // Detener cualquier vibraci√≥n previa
            
            if (navigator.vibrate) {
                function vibrateLoop() {
                    navigator.vibrate([300, 200, 300, 200, 400]);
                }
                
                vibrateLoop(); // Vibrar inmediatamente
                vibrateInterval = setInterval(vibrateLoop, 1000);
                
                alert('Vibraci√≥n continua iniciada por 10 segundos');
                
                // Detener despu√©s de 10 segundos
                setTimeout(() => {
                    stopVibration();
                    alert('Vibraci√≥n continua detenida');
                }, 10000);
            } else {
                alert('‚ùå Vibraci√≥n no soportada en este dispositivo');
            }
        }
        
        function stopVibration() {
            console.log('Deteniendo vibraci√≥n...');
            if (vibrateInterval) {
                clearInterval(vibrateInterval);
                vibrateInterval = null;
            }
            if (navigator.vibrate) {
                navigator.vibrate(0); // Detener vibraci√≥n
            }
            alert('Vibraci√≥n detenida');
        }
        
        // Evento para activar contexto con cualquier toque
        document.addEventListener('touchstart', () => {
            console.log('Pantalla tocada - contexto activado');
        }, { once: true });
        
        // Tambi√©n para click en caso de que no sea t√°ctil
        document.addEventListener('click', () => {
            console.log('Pantalla clickeada - contexto activado');
        }, { once: true });
    </script>
</body>
</html>
    `);
});

// P√°gina de prueba r√°pida
app.get('/test', (req, res) => {
    res.send(`
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba R√°pida</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background: #f0f0f0; }
        button { padding: 20px; margin: 10px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; color: white; width: 80%; max-width: 300px; }
        .vibrate { background: #ff6b6b; }
        .sound { background: #4ecdc4; }
        .both { background: #45b7d1; }
        .status { margin: 20px 0; padding: 15px; background: white; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>üîß Prueba R√°pida de Vibraci√≥n y Sonido</h1>
    
    <div class="status" id="status">
        Toca los botones para probar cada funci√≥n
    </div>
    
    <button class="vibrate" onclick="testVibrate()">üì≥ Probar Vibraci√≥n Constante</button>
    <button class="sound" onclick="testSound()">üîä Probar Sonido</button>
    <button class="both" onclick="testBoth()">üéØ Probar Ambos</button>
    <button onclick="stopAll()" style="background: #dc3545;">‚èπÔ∏è Detener Todo</button>
    
    <div class="status">
        <h3>üìã Para que funcione:</h3>
        <p>‚úÖ Usar HTTPS o localhost</p>
        <p>‚úÖ Tocar la pantalla primero</p>
        <p>‚úÖ Activar sonido en el dispositivo</p>
        <p>‚úÖ No estar en modo silencioso</p>
    </div>
    
    <script>
        const status = document.getElementById('status');
        let vibrateInterval = null;
        let audioContext = null;
        let beepInterval = null;
        
        function updateStatus(message, color = '#333') {
            status.innerHTML = message;
            status.style.color = color;
        }
        
        function testVibrate() {
            if ('vibrate' in navigator) {
                stopAll();
                
                function vibratePattern() {
                    navigator.vibrate([400, 100, 400, 100, 200, 50, 300]);
                }
                
                vibratePattern();
                vibrateInterval = setInterval(vibratePattern, 1200);
                
                updateStatus('üì≥ Vibraci√≥n constante activada (durar√° 30 segundos)', 'green');
                setTimeout(stopAll, 30000);
            } else {
                updateStatus('‚ùå Tu dispositivo no soporta vibraci√≥n', 'red');
            }
        }
        
        function testSound() {
            stopAll();
            createBeepLoop();
            updateStatus('üîä Sonido de alarma activado', 'green');
            setTimeout(stopAll, 10000);
        }
        
        function createBeepLoop() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                function createBeep() {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                    oscillator.type = 'square';
                    
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                }
                
                createBeep();
                beepInterval = setInterval(createBeep, 600);
            } catch (e) {
                updateStatus('‚ùå Error creando sonido: ' + e.message, 'red');
            }
        }
        
        function testBoth() {
            testVibrate();
            setTimeout(testSound, 200);
            updateStatus('üéØ Vibraci√≥n + Sonido activados', 'blue');
        }
        
        function stopAll() {
            if (vibrateInterval) {
                clearInterval(vibrateInterval);
                vibrateInterval = null;
                navigator.vibrate && navigator.vibrate(0);
            }
            
            if (beepInterval) {
                clearInterval(beepInterval);
                beepInterval = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            updateStatus('‚èπÔ∏è Todos los efectos detenidos', 'gray');
        }
        
        // Informaci√≥n del dispositivo
        window.addEventListener('load', () => {
            let info = 'üì± Informaci√≥n:<br>';
            info += 'Vibraci√≥n: ' + (navigator.vibrate ? '‚úÖ Soportada' : '‚ùå No soportada') + '<br>';
            info += 'Audio Context: ' + (window.AudioContext || window.webkitAudioContext ? '‚úÖ Soportado' : '‚ùå No soportado') + '<br>';
            info += 'Dispositivo: ' + (navigator.userAgent.includes('Mobile') ? 'üì± M√≥vil' : 'üñ•Ô∏è Escritorio');
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'status';
            infoDiv.innerHTML = info;
            document.body.appendChild(infoDiv);
        });
    </script>
</body>
</html>
    `);
});

io.on('connection', (socket) => {
    console.log('New client connected:', socket.id);
    
    // Evento principal de hackeo
    socket.on('hack', () => {
        console.log('Hack iniciado por:', socket.id);
        io.emit('startHack');
    });
    
    // Evento para detener el hackeo
    socket.on('stopHack', () => {
        console.log('Hack detenido por:', socket.id);
        io.emit('stopHack');
    });
    
    // Efectos individuales
    socket.on('flashColors', () => {
        io.emit('flashColors');
    });
    
    socket.on('vibrate', () => {
        io.emit('vibrate');
    });
    
    socket.on('playSound', () => {
        io.emit('playSound');
    });
    
    socket.on('disconnect', () => {
        console.log('Client disconnected:', socket.id);
    });
});

server.listen(PORT, () => {
    console.log(`‚úÖ Servidor corriendo en http://localhost:${PORT}`);
    console.log(`üéÆ Panel de control: http://localhost:${PORT}/`);
    console.log(`üì± C√≥digo QR: http://localhost:${PORT}/qr`);
    console.log(`üíª Demo hackeo: http://localhost:${PORT}/hack`);
    console.log(`üîß Prueba r√°pida: http://localhost:${PORT}/test`);
    console.log(`üì≥ PRUEBA VIBRACI√ìN: http://localhost:${PORT}/vibrate-test`);
    console.log(`üõë Parada emergencia: http://localhost:${PORT}/stop`);
});